Option Explicit
Public i As Integer
Public js As Range
Public getAddressColumn, ColumnJ, ColumnK As Variant
Public ColumnAA, ColumnAB, ColumnAF, ColumnU, ColumnV, ColumnN, ColumnO, ColumnAD, ColumnAE, ColumnY, ColumnSS, ColumnT As Variant
    
Public contador_Change, j As Integer
Public procurar As Variant
Public EndLine As Integer
Public ValorFormatado, Loja_Matricula As String
Public ColorS As String

Sub CalcPlan()

  Dim EndLineVendedor As Integer
  Dim SsTs, JsKs As String
  Dim k As Integer
  Dim comissao, DSR, premio As Variant
  Dim ErrosDetectados As Boolean
  Dim AAsAbs, AFs As String
  Dim Abertura_Loja As Double
  Dim EndLineClayton As Integer
  Dim WB As Workbook
  Dim pasta As Object
  Dim CaminhoPastaFerias, FileName, OldFileName, FileNameFerias As String
  Dim arquivo As Variant
  Dim QuantideDiaFerias As Variant
  Dim Percentual As Integer
  Dim EndLine_005 As Integer
  Dim EndLine_078 As Integer
  Dim X As Integer
  contador_Change = 0
  Application.ScreenUpdating = False
  EndLine = Range("A" & Rows.Count).End(xlUp).Row
  
  Set WB = Workbooks(1)
  
  k = 5
  
  'Abre a planilha vendas para que seja possível executar o VLookup(ProcV) de comissao,DSR e premio
  
  Workbooks.Open (ThisWorkbook.Path & "\Vendas.xlsm")
  
  EndLineVendedor = Workbooks("Vendas.xlsm").Worksheets("Vendedor").Range("A" & Rows.Count).End(xlUp).Row
  
  Range("V3:V" & EndLine).NumberFormat = "General"
  
  'Limpa dados que serão gravados através de código
  
  
  'Escolhendo o arquivo férias correto. (Sempre utilizará o último, sendo esse pela lógica o arquivo corrente)
  'Foi a alternativa que consegui para fazer com que funcionasse havendo no caso, mais que um arquivo de férias
 
  CaminhoPastaFerias = ThisWorkbook.Path & "\"
  Set pasta = CreateObject("Scripting.FileSystemObject").getFolder(CaminhoPastaFerias)
  
  For Each arquivo In pasta.Files
    
    FileName = InStr(arquivo.Name, "Férias")
    
    If (FileName > 0) Then
      FileNameFerias = arquivo.Name
    End If
    
  Next
 
  Workbooks.Open (ThisWorkbook.Path & "\" & FileNameFerias)
  
  Sheet1.ProgressBar1.Min = 0
  Sheet1.ProgressBar1.Max = EndLine

  
  'COntador da planilha erros!
  j = 2
  
  Sheet17.cells.Range("A3:A" & EndLine).Clear
  
  'Busca fim de linha planilha evento 005 (Sheet8)
  EndLine_005 = WB.Worksheets(8).Range("A" & Rows.Count).End(xlUp).Row
  EndLine_078 = WB.Worksheets(9).Range("A" & Rows.Count).End(xlUp).Row
  
  WB.Worksheets(8).Range("A5:F" & EndLine_005).Clear
  WB.Worksheets(8).Range("A5:F" & 1000).NumberFormat = "@"
  
  WB.Worksheets(9).Range("A5:F" & EndLine_005).Clear
  WB.Worksheets(9).Range("A5:F" & 1000).NumberFormat = "@"
  
  ColorS = "VbBlue"
  
  For i = 3 To EndLine
  
    'Barra de progresso para vc saber onde está
    Percentual = (i - 1) / (EndLine - 1) * 100
    Application.StatusBar = "Calculando dados da planilha... " & Percentual & "%"

    Sleep 3 '// Não estou utilizando pra delay anymore
    
    Loja_Matricula = Sheet1.cells(i, "C").Value
    
    'obtem os dados da planilha vendas e grava abaixo comissao, DSR e premio
    comissao = Application.VLookup(Loja_Matricula, Workbooks("Vendas.xlsm").Worksheets("Vendedor").Range("P5:S" & EndLineVendedor), 2, 0)
    
    If IsError(comissao) Then
      j = j + 1
      ErrosDetectados = True
      Sheet17.cells(j, "A").Value = "Vendedor não encontrado " & Loja_Matricula & " Linha-" & i & " Pasta Base"
    Else
      Sheet1.cells(i, "AA").Value = comissao
      
      If comissao > 0 Then
        Call Change_Color(Sheet1.cells, "AA", ColorS, i)
      End If
      
      DSR = Application.VLookup(Loja_Matricula, Workbooks("Vendas.xlsm").Worksheets("Vendedor").Range("P5:S" & EndLineVendedor), 3, 0)
      Sheet1.cells(i, "AB").Value = DSR
      
      If DSR > 0 Then
        Call Change_Color(Sheet1.cells, "AB", ColorS, i)
      End If
      
      premio = Application.VLookup(Loja_Matricula, Workbooks("Vendas.xlsm").Worksheets("Vendedor").Range("P5:S" & EndLineVendedor), 4, 0)
      Sheet1.cells(i, "AD").Value = premio
      
      If premio > 0 Then
        Call Change_Color(Sheet1.cells, "AD", ColorS, i)
      End If
      
    End If
    
    'obtem os dados da planilha ferias e grava abaixo a quantidade de dias atual de férias
      QuantideDiaFerias = BuscaQtdeDiasFerias(Sheet1.cells(i, "D").Value, Sheet1.cells, i, FileNameFerias)
     
    'Coluna U Total VT - AUTOMATIZADA
    SsTs = "S" & i & ":T" & i
    
    If i = 171 Then
       X = 1
    End If
    
    '***** ERRO A PARTIR DA LINHA 171, E TEM UM PROCV ESTRANHO, ACHO QUE TEREI QUE PERGUNTAR PARA O USUÁRIO******'
    
    Sheet1.cells(i, "U").Value = Reapura_U(Sheet1.cells, i, j, Loja_Matricula)
    
      Call Change_Color(Sheet1.cells, "U", ColorS, i)
   
    
    'Coluna J DIAS ATIVOS NA FOLHA - AUTOMATIZADA
    JsKs = "J" & i & ":K" & i
    
    Sheet1.cells(i, "J").Value = 30 - Sheet1.cells(i, "K").Value
    Call Change_Color(Sheet1.cells, "J", ColorS, i)
   
    'Coluna L Total - AUTOMATIZADA
    Sheet1.cells(i, "L").Value = WorksheetFunction.Sum(Range(JsKs))
    Call Change_Color(Sheet1.cells, "L", ColorS, i)
        
    'Coluna V 6% VT - AUTOMATIZADA
    
    'Aqui, caso a loja seja 175, o valor na coluna V deve ser o Sal. fixo
    Sheet1.cells(i, "V").Value = Reapura_V(Sheet1.cells, i)
    
    If Sheet1.cells(i, "V").Value Then
        Call Change_Color(Sheet1.cells, "V", ColorS, i)
    End If
    'Coluna W Desconto VT Folha
    Sheet1.cells(i, "W").Value = Reapura_W(Sheet1.cells, i)
    Call Change_Color(Sheet1.cells, "W", ColorS, i)
    
    'Coluna Y Desconto VT Folha
    Sheet1.cells(i, "Y").Value = Reapura_Y(Sheet1.cells, i)
    Call Change_Color(Sheet1.cells, "Y", ColorS, i)
    
    'Coluna AE Total
    Sheet1.cells(i, "AE").Value = Reapura_AE(Sheet1.cells, i)
    If Sheet1.cells(i, "AE").Value > 0 Then
      Call Change_Color(Sheet1.cells, "AE", ColorS, i)
    End If
    
    'Coluna AF
    Sheet1.cells(i, "AF").Value = Reapura_AF(Sheet1.cells, i)
    If Sheet1.cells(i, "AF").Value > 0 Then
      Call Change_Color(Sheet1.cells, "AF", ColorS, i)
    End If
    'Planilha Clayton
    'Necessário abir essa porque ao chega aqui, a planilha ativa é Base, e para efetuar essa busca, precisa que essa pasta esteja ativa
    WB.Worksheets("Prêmio_Clayton").Activate
      Call EncontrePorNome(Sheet1.cells(i, "D").Value, Sheet1.cells, i)
      
    'Volta a ativar a planilha principal - Base antes de ir para o próximo registro
    WB.Worksheets(1).Activate
    
    'Incrementa progressBar
    
    Sheet1.ProgressBar1.Value = i
    k = k + 1
    ' Gera Arquivo Texto
    'Evento 005 Sheet8
    
    If Sheet1.cells(i, "AA").Value > 0 Then
      WB.Worksheets(8).cells(k, "A").Value = Format(Sheet1.cells(i, "A").Value, "0000")
      Sheet8.cells(k, "B").Value = Format(Sheet1.cells(i, "B").Value, "00000")
      Sheet8.cells(k, "C").Value = Format(5, "000")
      ValorFormatado = Format(Sheet1.cells(i, "AA").Value, "0000000000.00")
      Sheet8.cells(k, "D").Value = Mid(ValorFormatado, 1, 10) & Mid(ValorFormatado, 12, 2)
      Sheet8.cells(k, "E").Value = Sheet1.cells(i, "AA").Value
    End If
    
     'Evento 078 Sheet8
    If Sheet1.cells(i, "AC").Value > 0 Then
      WB.Worksheets(9).cells(k, "A").Value = Format(Sheet1.cells(i, "A").Value, "0000")
      Sheet9.cells(k, "B").Value = Format(Sheet1.cells(i, "B").Value, "00000")
      Sheet9.cells(k, "C").Value = Format(78, "000")
      ValorFormatado = Format(Sheet1.cells(i, "AC").Value, "0000000000.00")
      Sheet9.cells(k, "D").Value = Mid(ValorFormatado, 1, 10) & Mid(ValorFormatado, 12, 2)
      Sheet9.cells(k, "E").Value = Sheet1.cells(i, "AC").Value
    End If
  
 
    Next i
    Application.ScreenUpdating = True
    Application.DisplayAlerts = True
 
    If ErrosDetectados = True Then
      MsgBox "Erros na busca de 'vendedores' na planilha vendas.xlsm verifique pasta """"Erros"""""
    End If
  
    'Apenas Fecha a planilha Vendas
    Workbooks("Vendas.xlsm").Close
    Workbooks(FileNameFerias).Close
    WB.Worksheets(1).Activate
    Sheet1.ProgressBar1.Value = 0
    Range("Y3").Select
End Sub

'Controla tudo que necessita ser recalculado a partir de uma alteração feita pelo usuário em determinadas células


Private Sub Worksheet_Change(ByVal Target As Range)
  contador_Change = contador_Change + 1
  If contador_Change = 1 Then

    getAddressColumn = CStr(Target.Address)
    ColumnJ = InStr(getAddressColumn, "J")
    ColumnK = InStr(getAddressColumn, "K")
    ColumnAA = InStr(getAddressColumn, "AA")
    ColumnAB = InStr(getAddressColumn, "AB")
    ColumnAF = InStr(getAddressColumn, "AF")
    ColumnU = InStr(getAddressColumn, "U")
    ColumnV = InStr(getAddressColumn, "V")
    ColumnN = InStr(getAddressColumn, "N")
    ColumnO = InStr(getAddressColumn, "O")
    ColumnAD = InStr(getAddressColumn, "AD")
    ColumnAE = InStr(getAddressColumn, "AE")
    ColumnY = InStr(getAddressColumn, "Y")
    ColumnSS = InStr(getAddressColumn, "S")
    ColumnT = InStr(getAddressColumn, "T")


    'Ou seja, se houve alteração em qq uma dessas colunas pela ação do usuário, elas são recalculadas
    'Sendo L a somatoria de J e K representado por Reapura_L, e Repura_J que ao detectar alteração em J ou K, reapura J

    If (ColumnJ > 0) Or (ColumnK > 0) Then
      Call Reapura_J(Sheet1.cells, Target.Row)
      Call Reapura_L(Sheet1.cells, Target.Row)
    End If

    'Ou seja, se houve alteração em qq uma dessas colunas(AA e AB e AF) pela ação do usuário, elas são recalculadas
    'Sendo V a somatoria de AA e AB e AF

    If (ColumnAA > 0) Or (ColumnAB > 0) Or (ColumnAF > 0) Then
      Sheet1.cells(Target.Row, "V").Value = Reapura_V(Sheet1.cells, Target.Row)
    End If

    If (ColumnU > 0) Or (ColumnV > 0) Then
      Sheet1.cells(Target.Row, "W").Value = Reapura_W(Sheet1.cells, Target.Row)
    End If

    If (ColumnN > 0) Or (ColumnO > 0) Or (ColumnJ > 0) Then
      Sheet1.cells(Target.Row, "Y").Value = Reapura_Y(Sheet1.cells, Target.Row)
    End If

    If (ColumnAA > 0) Or (ColumnAD > 0) Then
      Sheet1.cells(Target.Row, "AE").Value = Reapura_AE(Sheet1.cells, Target.Row)
    End If

     If (ColumnAE > 0) Or (ColumnY > 0) Or (ColumnN > 0) Or (ColumnO > 0) Or (ColumnJ > 0) Then
      Sheet1.cells(Target.Row, "AF").Value = Reapura_AF(Sheet1.cells, Target.Row)
    End If

     If (ColumnSS > 0) Or (ColumnT > 0) Then
      Sheet1.cells(Target.Row, "U").Value = Reapura_U(Sheet1.cells, Target.Row, j, Loja_Matricula)
    End If


  contador_Change = 0

  End If

End Sub

'Dias Ativo
Sub Reapura_J(Acells As Range, ALine As Integer)
  Acells.cells(ALine, "J").Value = Acells.cells(ALine, "J").Value - Acells.cells(ALine, "K").Value
End Sub

'Total Dias
Sub Reapura_L(Acells As Range, ALine As Integer)
  Acells.cells(ALine, "L").Value = Acells.cells(ALine, "J").Value + Acells.cells(ALine, "K").Value
  
End Sub

'VT 6%
Function Reapura_V(Acells As Range, ALine As Integer)
  
   If Acells.cells(ALine, "A").Value = 175 Then
      Reapura_V = CDbl(FormatNumber(Acells.cells(ALine, "N").Value * (6 / 100), 2))
    Else
      Reapura_V = (Acells.cells(ALine, "AA").Value + Acells.cells(ALine, "AB").Value + Acells.cells(ALine, "AF").Value) * (6 / 100)
    End If
End Function

'VT comparação
Function Reapura_W(Acells As Range, ALine As Integer)
     '=IF(U>V;V;U)
    Reapura_W = Acells.cells(ALine, "U").Value
    If (Acells.cells(ALine, "U").Value > Acells.cells(ALine, "V").Value) Or (Acells.cells(ALine, "U").Value = 0) Then
      Reapura_W = Acells.cells(ALine, "V").Value
    End If
End Function

'Total variáveis
Function Reapura_Y(Acells As Range, ALine As Integer)
    ''=SUM(N3:O3)/30*J3
    Reapura_Y = ((Acells.cells(ALine, "N").Value + Acells.cells(ALine, "O").Value) / (30) * (Acells.cells(ALine, "J").Value))
  
End Function


'Total variáveis
Function Reapura_AE(Acells As Range, ALine As Integer)
  Reapura_AE = (Acells.cells(ALine, "AA").Value + Acells.cells(ALine, "AD").Value)
End Function


Function Reapura_AF(Acells As Range, ALine As Integer)
    '=IF(AE3<Y3;Y3-AE3;0)
    Reapura_AF = 0
    If Acells.cells(ALine, "AE").Value < Acells.cells(ALine, "Y").Value Then
      Reapura_AF = ((Acells.cells(ALine, "Y").Value) - (Acells.cells(ALine, "AE").Value))
    End If
  
End Function

'Total variáveis
Function Reapura_U(Acells As Range, ALine As Integer, ByVal AJ As Integer, ALoja_Matricula As String)
  If IsNumeric(Acells.cells(ALine, "S").Value) And IsNumeric(Acells.cells(ALine, "T").Value) Then
    Reapura_U = (Acells.cells(ALine, "S").Value + Acells.cells(ALine, "T").Value)
  Else
    Reapura_U = 0
    Sheet17.cells(AJ, "A").Value = "Coluna U foi zerada. Motivo:Coluna U, utiliza as Celulas S e T, uma das duas não é um valor para ser somado, verifique  " & ALoja_Matricula & " Linha-" & ALine & " Pasta Base"
  End If
  
End Function



Public Sub EncontrePorNome(ANome As String, Acells As Range, ALine)

Set procurar = Worksheets("Prêmio_Clayton").cells.Find(What:=ANome, After:=ActiveCell, _
LookIn:=xlValues, LookAt:=xlPart, SearchOrder:=xlByRows, _
SearchDirection:=xlNext, MatchCase:=False)
 
If Not (procurar Is Nothing) Then
   
   If procurar.Column = 3 Then
     If procurar.cells.Find(ANome).Offset(0, 5) > 0 Then
        Acells.cells(ALine, "AG").Value = FormatNumber(procurar.cells.Find(ANome).Offset(0, 5), 2)
        Acells.cells(ALine, "AG").Interior.Color = vbBlack
        Acells.cells(ALine, "AG").Font.Color = vbWhite
        Acells.cells(ALine, "AG").Font.Bold = True
     End If
     
     If (procurar.cells.Find(ANome).Offset(0, 6).Value > 0) Or (procurar.cells.Find(ANome).Offset(0, 7).Value) Then
        Acells.cells(ALine, "AC").Value = FormatNumber(((procurar.cells.Find(ANome).Offset(0, 6).Value) + (procurar.cells.Find(ANome).Offset(0, 7).Value)), 2)
        Acells.cells(ALine, "AC").Interior.Color = vbBlack
        Acells.cells(ALine, "AC").Font.Color = vbWhite
        Acells.cells(ALine, "AC").Font.Bold = True
     End If
   
   End If
End If

End Sub

Function BuscaQtdeDiasFerias(ANome As String, Acells As Range, ALine, AWorkBook As String)

Set procurar = Workbooks(AWorkBook).Worksheets(1).cells.Find(What:=ANome, After:=ActiveCell, _
LookIn:=xlValues, LookAt:=xlPart, SearchOrder:=xlByRows, _
SearchDirection:=xlNext, MatchCase:=False)
 
If Not (procurar Is Nothing) Then
     Acells.cells(ALine, "K").Value = procurar.cells.Find(ANome).Offset(0, 8)
   
     Acells.cells(ALine, "K").Interior.Color = vbRed
     Acells.cells(ALine, "K").Font.Color = vbWhite
     Acells.cells(ALine, "K").Font.Bold = True
End If

End Function

Sub Limpa()

   EndLine = Range("A" & Rows.Count).End(xlUp).Row
   
   Sheet1.Range("J3:K" & EndLine).Interior.Color = vbWhite
   Sheet1.Range("J3:K" & EndLine).Font.Color = vbBlack
   Sheet1.Range("J3:K" & EndLine).Font.Bold = False
    
   Sheet1.Range("K3:K" & EndLine).Interior.Color = vbWhite
   Sheet1.Range("K3:K" & EndLine).Font.Color = vbBlack
   Sheet1.Range("K3:K" & EndLine).Font.Bold = False
   
   Sheet1.Range("AC3:AC" & EndLine).Interior.Color = vbWhite
   Sheet1.Range("AC3:AC" & EndLine).Font.Color = vbBlack
   Sheet1.Range("AC3:AC" & EndLine).Font.Bold = False
   
   Sheet1.Range("AG3:AG" & EndLine).Interior.Color = vbWhite
   Sheet1.Range("AG3:AG" & EndLine).Font.Color = vbBlack
   Sheet1.Range("AG3:AGC" & EndLine).Font.Bold = False
   
   Sheet1.Range("AA3:AA" & EndLine).ClearContents
   Sheet1.Range("AA3:AA" & EndLine).Interior.Color = vbWhite
   Sheet1.Range("AA3:AA" & EndLine).Font.Color = vbBlack
   
   
   Sheet1.Range("AB3:AB" & EndLine).ClearContents
   Sheet1.Range("AB3:AB" & EndLine).Interior.Color = vbWhite
   Sheet1.Range("AB3:AB" & EndLine).Font.Color = vbBlack
   
   Sheet1.Range("AD3:AD" & EndLine).ClearContents
   Sheet1.Range("AD3:AD" & EndLine).Interior.Color = vbWhite
   Sheet1.Range("AD3:AD" & EndLine).Font.Color = vbBlack
   
   Sheet1.Range("U3:U" & EndLine).ClearContents
   Sheet1.Range("U3:U" & EndLine).Interior.Color = vbWhite
   Sheet1.Range("U3:U" & EndLine).Font.Color = vbBlack
   
   Sheet1.Range("L3:L" & EndLine).ClearContents
   Sheet1.Range("L3:L" & EndLine).Interior.Color = vbWhite
   Sheet1.Range("L3:L" & EndLine).Font.Color = vbBlack
   
   
   Sheet1.Range("V3:V" & EndLine).ClearContents
   Sheet1.Range("V3:V" & EndLine).Interior.Color = vbWhite
   Sheet1.Range("V3:V" & EndLine).Font.Color = vbBlack
      
   Sheet1.cells.Range("W3:W" & EndLine).ClearContents
   Sheet1.cells.Range("W3:W" & EndLine).Interior.Color = vbWhite
   Sheet1.Range("W3:W" & EndLine).Font.Color = vbBlack
   
   Sheet1.cells.Range("Y3:Y" & EndLine).ClearContents
   Sheet1.cells.Range("Y3:Y" & EndLine).Interior.Color = vbWhite
   Sheet1.Range("Y3:Y" & EndLine).Font.Color = vbBlack
      
   Sheet1.cells.Range("AE3:AE" & EndLine).ClearContents
   Sheet1.cells.Range("AE3:AE" & EndLine).Interior.Color = vbWhite
   Sheet1.Range("AE3:AE" & EndLine).Font.Color = vbBlack
   
   Sheet1.cells.Range("AF3:AF" & EndLine).ClearContents
   Sheet1.cells.Range("AF3:AF" & EndLine).Interior.Color = vbWhite
   Sheet1.Range("AF3:AF" & EndLine).Font.Color = vbBlack
   

End Sub

Sub Change_Color(Acells As Range, ACell As String, aColor As String, ALine As Integer)

  If aColor = "VbBlue" Then
    Acells.cells(ALine, ACell).Interior.Color = RGB(68, 114, 186)
  End If
  Acells.cells(ALine, ACell).Font.Color = vbWhite
  Acells.cells(ALine, ACell).Font.Bold = True
         
End Sub


'Coluna AA e AB respectivamente obtidas da planilha
'Vendas.xlsx Coluna que está em C:\Users\Robson\Documents\Planilhas para automação
'AA - P
'AB -Q porém,essa coluna AB não será considerada para geração dos eventos.
'AD - Utilizar a coluna R também de Vendas.xlsx

'Botão para gerar colunas em uma única aba/sheet
'e gerar um arquivo texto contendo todas as abas/eventos (em um único arquivo)

'Se a loja for Goiânia 175,  o cálculo será diferente para apurar o VT
'somente Salário Fixo

'Para as abas Prêmio William e Prêmio Clayton, utilizar os funcionários(vai conseguir fazer com que as pessoas sejam identificadas
'unicamente (Chapa )
'Localizar a pessoa na pasta principal, "Base 06-2021" para q a coluna H a K(Pasta do Clayton, por exemplo) seja gravada
' Sendo que a coluna I + J deve ser somada, trata do mesmo evento 078 gravado na Coluna AC
'Código de substuição, que na pasta do Clayton é coluna, foi enviado por e-mail

'Daqui para baixo - Grava Arquivo texto

'Colunas Q, R e T gerar duas linhas. pois trata-se de evento de entrada e saída.
'Coluna W, mesmo que seja ífen, ´precisa gerar o evento(VT) kiprokó/custipil do tal do prósoft
'Coluna K, Usuario vai tentar conseguir uma planilha que contenha os dados de férias para trazer para essa planilha
'O código do evento de substituição é 310.
