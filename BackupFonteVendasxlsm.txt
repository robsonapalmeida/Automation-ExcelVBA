
Public EndLine As Integer

Private Sub CommandButton1_Click()

Dim Sh As Sheets

Dim i, j, Loja As Integer
Dim EndLineS, EndLineSGerente As String
Dim Percentuais As String
Dim Perc_Atingido As Double
Dim QtdeElementosArray As Integer
Dim Percentual_Comissao As Double
Dim ErrosDetectados, ErrosGerentesDetectados As Boolean

  Sheets("Vendedor").Select
  ErrosDetectados = False
  ErrosGerentesDetectados = False
  Call atribui_fimLinha
  EndLineS = "A5:I" & EndLine
 
  Sheet1.cells.Range("P5:R" & EndLine).Clear
  Sheet4.cells.Range("A2:A100").Clear
  
 
  j = 2
  
  For i = 5 To EndLine
  Perc_Atingido = 0
  Percentuais = 0
  
  QtdeElementosArray = 99
  
  'Grava loja+matricula para busca de vlookup
  If (Sheet1.cells(i, "A").Value <> "") And (Sheet1.cells(i, "B").Value <> "") Then
    Loja = CInt(Sheet1.cells(i, "A").Value)
    Matricula = CInt(Sheet1.cells(i, "B").Value)
    Loja_Matricula = CStr(Loja) & "-" & CStr(Matricula)
    Sheet1.cells(i, "U").Value = Loja_Matricula
  End If
  
  ' Copia celulas das colunas P,Q,R para V,W,X, a razão é q a planilha (Planilha Base folha de pagamento MES-ANO.xlsm)
  ' Usa a coluna U que concatena Loja+Matricula para buscar aqui os dados de P,Q e R e gravar lá em (Planilha Base folha de pagamento MES-ANO.xlsm)
  ' Isso para fazer um vLookup lá e conseguir obter os valore corretamente.
   
  Range("A1").Copy Range("A2")
  
  
    If (Sheet1.cells(i, "A").Value) <> "" And (Sheet1.cells(i, "B").Value) <> "" And (Sheet1.cells(i, "A").Value) <> "Loja" Then
    
      '1. 'Vlookup deve utiliza célula A de vendedor, buscar em Sheet 2 entre A e I até o fim da planilha e retorna no caso abaixo a coluna G
       On Error Resume Next
       Percentuais = Application.VLookup(CInt(Sheet1.cells(i, "A").Value), Sheet2.Range(EndLineS), 7, False)
         
       If Err.Number <> 0 Then
          j = j + 1
          ErrosDetectados = True
          Sheet4.cells(j, "A").Value = "Não existe % de comissão definido para a  loja - " & CInt(Sheet1.cells(i, "A").Value) & " - " & "Verifique planilha NB Linha - " & i
       End If
    
       PercentualArray = Split(Percentuais, "/")
       '2. Utiliza Coluna M, percentual atingido de meta, para enquadrar nas faixas, obviamente que se na nessa loja existir apenas um único %
       '   na coluna G da Sheet "NB", já interrompe a busca aqui.
     
       Perc_Atingido = FormatNumber(Sheet1.cells(i, "M").Value * 100, 2)
     
       QtdeElementosArray = UBound(PercentualArray)
     
       If ErrosDetectados = False Then
         Select Case QtdeElementosArray
       
           Case 0
             Call ApuracaoFx0(QtdeElementosArray, i, Perc_Atingido, Percentual_Comissao, PercentualArray, Sheet1.cells)
         
           Case 1
             Call ApuracaoFx1(QtdeElementosArray, i, Perc_Atingido, Percentual_Comissao, PercentualArray, Sheet1.cells)
      
           Case 2
             Call ApuracaoFx2(QtdeElementosArray, i, Perc_Atingido, Percentual_Comissao, PercentualArray, Sheet1.cells)
         
           Case 3
             Call ApuracaoFx3(QtdeElementosArray, i, Perc_Atingido, Percentual_Comissao, PercentualArray, Sheet1.cells)
         
         End Select
       End If
    End If
   
  Next i
  
  If ErrosDetectados = True Then
    MsgBox "Erros Em 'Vendedores' foram detectados, verifique Aba """"Erros"""""
  End If
  
  
  'Gerentes
  Sheets("Gerentes").Select
  EndLine = Sheets("Gerentes").Range("B" & Rows.Count).End(xlUp).Row - 1
  EndLineSGerente = "A5:M" & EndLine
  Sheets("Gerentes").cells.Range("O4:Q" & EndLine).Clear
  For k = 4 To EndLine
    
    
    On Error Resume Next
      Percentuais = Application.VLookup(CInt(Sheets("Gerentes").cells(k, "B").Value), Sheet2.Range(EndLineSGerente), 5, False)
      
      s = InStr(Trim(Percentuais), "%")
      
      If s > 0 Then
        Percentual_Comissao = Mid(Percentuais, 1, s - 1) / 100
      End If
      
      If Err.Number <> 0 Then
        j = j + 1
        ErrosGerentesDetectados = True
        Sheet4.cells(j, "A").Value = "Não existe % de comissão definido para o Gerente da loja  - " & CInt(Sheets("Gerentes").cells(k, "B").Value) & " - " & "Verifique planilha NB Linha - " & k
      End If
   
      If ErrosGerentesDetectados = False Then
        ValorGerente = Sheets("Gerentes").cells(k, "K").Value * Percentual_Comissao
        Sheets("Gerentes").cells(k, "O").Value = FormatNumber(ValorGerente, 2)
        Sheets("Gerentes").cells(k, "P").Value = Sheets("Gerentes").cells(k, "O").Value * 0.25
      End If
      
      If CDbl(Sheets("Gerentes").cells(k, "M").Text) >= 100 And (ErrosGerentesDetectados = False) Then
        ComissaoGerente = Application.VLookup(CInt(Sheets("Gerentes").cells(k, "B").Value), Sheet2.Range(EndLineSGerente), 6, False)
        ss = InStr(Trim(ComissaoGerente), " ")
        ComissaoGerente = CDbl(Mid(ComissaoGerente, 1, ss - 1))
        Sheets("Gerentes").cells(k, "Q").Value = ComissaoGerente
      End If
    
  
  Next k
  
  
  If ErrosGerentesDetectados = True Then
    MsgBox "Erros na apuração dos gerentes foram detectados, verifique Aba """"Erros"""""
  End If
  
  
  Sheets("Vendedor").Select
  
End Sub

Public Sub ApuracaoFx0(ByRef AQtdeElementosArray As Integer, ByVal Ai As Integer, ByRef APerc_Atingido As Double, ByVal APercentual_Comissao As Double, ByRef APercentualArray As Variant, ACells As Range)
             
             If ((APerc_Atingido >= Sheet2.cells(2, "M").Value) And (APerc_Atingido <= Sheet2.cells(2, "N").Value)) Or APerc_Atingido >= Sheet2.cells(2, "N").Value Then
                s = InStr(Trim(APercentualArray(0)), "%")
                If s > 0 Then
                  APercentual_Comissao = (Mid(Trim(APercentualArray(0)), 1, s - 1)) / 100
                  ACells.cells(Ai, "P").Value = ACells.cells(Ai, "J").Value * APercentual_Comissao
                  ACells.cells(Ai, "Q").Value = ACells.cells(Ai, "P").Value * 0.25
                Else
                  APercentual_Comissao = APercentualArray(0)
                  ACells.cells(Ai, "P").Value = ACells.cells(Ai, "J").Value * APercentual_Comissao
                  ACells.cells(Ai, "Q").Value = ACells.cells(Ai, "P").Value * 0.25
                End If
               
                '0,5% caso atinga a meta
                'If (APerc_Atingido >= Sheet2.cells(2, "N").Value) Then
                If (APerc_Atingido >= 100) Then
                
                  ACells.cells(Ai, "R").Value = ACells.cells(Ai, "J").Value * 0.005
                End If
             End If
            
End Sub

Public Sub ApuracaoFx1(ByRef AQtdeElementosArray As Integer, ByVal Ai As Integer, ByRef APerc_Atingido As Double, ByVal APercentual_Comissao As Double, ByRef APercentualArray As Variant, ACells As Range)
        If (AQtdeElementosArray = 1) Or (AQtdeElementosArray = 2) Or (AQtdeElementosArray = 3) Then
        
           If (APerc_Atingido < Sheet2.cells(3, "M").Value) Then
             Call ApuracaoFx0(AQtdeElementosArray, Ai, APerc_Atingido, APercentual_Comissao, APercentualArray, ACells)
           End If
           
        
           If ((APerc_Atingido >= Sheet2.cells(3, "M").Value) And (APerc_Atingido <= Sheet2.cells(3, "N").Value)) Or APerc_Atingido >= Sheet2.cells(3, "N").Value Then
             s = InStr(Trim(APercentualArray(1)), "%")
             APercentual_Comissao = Mid(Trim(APercentualArray(1)), 1, s - 1) / 100
             ACells.cells(Ai, "P").Value = ACells.cells(Ai, "J").Value * APercentual_Comissao
             ACells.cells(Ai, "Q").Value = ACells.cells(Ai, "P").Value * 0.25
           End If
            
           '0,5% caso atinga a meta
           'If (APerc_Atingido >= Sheet2.cells(3, "N").Value) Then
           If (APerc_Atingido >= 100) Then
              ACells.cells(Ai, "R").Value = ACells.cells(Ai, "J").Value * 0.005
           End If
          
        End If
         
End Sub


Public Sub ApuracaoFx2(ByRef AQtdeElementosArray As Integer, ByVal Ai As Integer, ByRef APerc_Atingido As Double, ByVal APercentual_Comissao As Double, ByRef APercentualArray As Variant, ACells As Range)
        If (AQtdeElementosArray = 2) Or (AQtdeElementosArray = 3) Then
           
           If (APerc_Atingido < Sheet2.cells(4, "M").Value) Then
             Call ApuracaoFx1(AQtdeElementosArray, Ai, APerc_Atingido, APercentual_Comissao, APercentualArray, ACells)
           End If
        
           If ((APerc_Atingido >= Sheet2.cells(4, "M").Value) And (APerc_Atingido <= Sheet2.cells(4, "N").Value)) Or APerc_Atingido >= Sheet2.cells(4, "N").Value Then
             s = InStr(Trim(APercentualArray(2)), "%")
             APercentual_Comissao = Mid(Trim(APercentualArray(2)), 1, s - 1) / 100
             ACells.cells(Ai, "P").Value = ACells.cells(Ai, "J").Value * APercentual_Comissao
             ACells.cells(Ai, "Q").Value = ACells.cells(Ai, "P").Value * 0.25
           End If
            
           '0,5% caso atinga a meta
           'If (APerc_Atingido >= Sheet2.cells(4, "N").Value) Then
           If (APerc_Atingido >= 100) Then
              ACells.cells(Ai, "R").Value = ACells.cells(Ai, "J").Value * 0.005
           End If
          
        End If
         
End Sub

Public Sub ApuracaoFx3(ByRef AQtdeElementosArray As Integer, ByVal Ai As Integer, ByRef APerc_Atingido As Double, ByVal APercentual_Comissao As Double, ByRef APercentualArray As Variant, ACells As Range)
        If (AQtdeElementosArray = 2) Or (AQtdeElementosArray = 3) Then
           
           If (APerc_Atingido < Sheet2.cells(5, "M").Value) Then
             Call ApuracaoFx2(AQtdeElementosArray, Ai, APerc_Atingido, APercentual_Comissao, APercentualArray, ACells)
           End If
        
           If ((APerc_Atingido >= Sheet2.cells(5, "M").Value) And (APerc_Atingido <= Sheet2.cells(5, "N").Value)) Or APerc_Atingido >= Sheet2.cells(5, "N").Value Then
             s = InStr(Trim(APercentualArray(3)), "%")
             APercentual_Comissao = Mid(Trim(APercentualArray(3)), 1, s - 1) / 100
             ACells.cells(Ai, "P").Value = ACells.cells(Ai, "J").Value * APercentual_Comissao
             ACells.cells(Ai, "Q").Value = ACells.cells(Ai, "P").Value * 0.25
           End If
            
           '0,5% caso atinga a meta
           'If (APerc_Atingido >= Sheet2.cells(4, "N").Value) Then
           If (APerc_Atingido >= 100) Then
              ACells.cells(Ai, "R").Value = ACells.cells(Ai, "J").Value * 0.005
           End If
          
        End If
         
End Sub


Public Sub ApuracaoGerente(ByVal Ak As Integer, ByRef APerc_Atingido As Double, ByVal APercentual_Comissao As Double, ACells As Range)
             
             If ((APerc_Atingido >= Sheet2.cells(2, "M").Value) And (APerc_Atingido <= Sheet2.cells(2, "N").Value)) Or APerc_Atingido >= Sheet2.cells(2, "N").Value Then
                s = InStr(Trim(APercentualArray(0)), "%")
                If s > 0 Then
                  APercentual_Comissao = (Mid(Trim(APercentualArray(0)), 1, s - 1)) / 100
                  ACells.cells(Ak, "P").Value = ACells.cells(Ak, "J").Value * APercentual_Comissao
                  ACells.cells(Ai, "Q").Value = ACells.cells(Ak, "P").Value * 0.25
                Else
                  APercentual_Comissao = APercentualArray(0)
                  ACells.cells(Ak, "P").Value = ACells.cells(Ak, "J").Value * APercentual_Comissao
                  ACells.cells(Ak, "Q").Value = ACells.cells(Ak, "P").Value * 0.25
                End If
               
                '0,5% caso atinga a meta
                'If (APerc_Atingido >= Sheet2.cells(2, "N").Value) Then
                If (APerc_Atingido >= 100) Then
                
                  ACells.cells(Ak, "R").Value = ACells.cells(Ak, "J").Value * 0.005
                End If
             End If
            
End Sub

    '    uma vez encontrado, utiliza coluna G, e para cada caractere % encontrado, significa um % de meta
    ',   nesse momento usar coluna M de sheet1 para pesquisar a faixa que está nas colunas M até O
    '    usar split para quebrar o array pelo simbolo /
    
    '2.    Coluna P de Sheet1(Vendedor) calculará a comissão, seria coluna J * % encontrado de comissão baseado na meta
    '3.    Coluna Q de Sheet1(Vendedor) calculará 0,25% sobre coluna P
    '4.    Coluna R de Sheet1(Vendedor) calculará 1/2%  sobre a venda caso exista o atingimento da Meta
    '5.    Sheet3(Gerentes), mesma lógica de apuração de comissão, única diferença é que não apura 1/2% de prémio, mas sim 2.000 reais fixos
   
    'Precisa ajustar o endlineS da linha abaixo
    '  Percentuais = Application.VLookup(CInt(Sheet1.cells(i, "A").Value), Sheet2.Range(EndLineS), 7, False)
    '  pois essa planilha sheet2, vai apnas até a linha 31
   
   
Private Sub CommandButton2_Click()
   atribui_fimLinha
   Sheet1.cells.Range("P5:R" & EndLine).Clear
End Sub

Sub atribui_fimLinha()
  EndLine = Range("A" & Rows.Count).End(xlUp).Row + 1
End Sub
